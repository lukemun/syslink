# SST Ion Migration Guide

## Overview

The `weather-crawler` app has been migrated from SST v2 (CDK-based) to SST Ion (Pulumi-based). This document outlines the changes and provides deployment instructions.

## What Changed

### Configuration File (`sst.config.ts`)

- **Old (SST v2)**: Used `SSTConfig` interface with `config()` and `stacks()` functions
- **New (Ion)**: Uses `$config()` with `app()` and `async run()` functions

### Stack Definition

- **Old**: Stack defined in `stacks/WeatherCrawlerStack.ts` using `StackContext` and CDK constructs
- **New**: Resources defined inline in `sst.config.ts` `run()` function using Ion constructs

### Resource Changes

| Resource | Old (SST v2) | New (Ion) |
|----------|--------------|-----------|
| Cron Job | `new Cron(stack, "WeatherCrawlerCron", {...})` | `new sst.aws.Cron("WeatherCrawlerCron", {...})` |
| Handler | `packages/functions/src/index.handler` | Same |
| Schedule | `rate(1 hour)` | Same |
| Memory | `512 MB` | Same |
| Timeout | `5 minutes` | Same |
| Environment | `DATABASE_URL` | Same |
| Dependencies | `nodejs.install: ["pg"]` | Same |

## Environment Variables

The function requires the following environment variable:

- `DATABASE_URL` - Postgres connection string (direct or pooled)

### Setting Environment Variables

**Option 1: Using `.env` file (recommended for local development)**

Create or update `../.env` at the repository root:

```bash
DATABASE_URL=postgresql://user:password@host:5432/database
```

The Ion config automatically loads this file using `dotenv`.

**Option 2: Using SST secrets (recommended for production)**

```bash
sst secret set DATABASE_URL "postgresql://user:password@host:5432/database" --stage production
```

## Deployment Instructions

### Prerequisites

1. SST v3.17.23 or higher (already installed)
2. AWS credentials configured (`aws configure` or environment variables)
3. Database URL set via `.env` or SST secrets

### Deploy to Development Stage

```bash
cd weather-crawler
npm install  # Ensure dependencies are up to date
sst deploy --stage dev
```

### Deploy to Production Stage

```bash
cd weather-crawler
sst deploy --stage production
```

### Verify Deployment

After deployment, verify the resources:

```bash
# Check stack outputs
sst deploy --stage dev

# View the deployed Cron function in AWS Console:
# Lambda > Functions > filter for "weather-crawler-dev-WeatherCrawlerCron"

# Check CloudWatch Logs for execution
aws logs tail /aws/lambda/weather-crawler-dev-WeatherCrawlerCron --follow --stage dev
```

### Test the Cron Function Manually

You can invoke the Lambda function directly to test:

```bash
aws lambda invoke \
  --function-name weather-crawler-dev-WeatherCrawlerCron \
  --log-type Tail \
  output.json

cat output.json
```

## Cleanup

### Remove Old SST v2 State (after successful Ion deployment)

Once you've confirmed the Ion deployment works correctly:

1. **Archive the old stack file** (optional, for reference):
   ```bash
   mkdir -p stacks/archive
   mv stacks/WeatherCrawlerStack.ts stacks/archive/
   mv stacks/MyStack.ts stacks/archive/  # If unused
   ```

2. **Remove old SST v2 state** (if it exists):
   ```bash
   rm -rf .sst  # Will be regenerated by Ion
   ```

### Remove Deployed Resources

To tear down all deployed resources:

```bash
sst remove --stage dev
sst remove --stage production
```

## Troubleshooting

### Linter Errors Before First Deployment

TypeScript may show errors like "Cannot find name '$config'" before the first deployment. This is normal - SST Ion generates type definitions during the first `sst deploy` or `sst dev` run.

### Database Connection Errors

If the Lambda fails with database connection errors:

1. Verify `DATABASE_URL` is set correctly
2. Check that the database allows connections from AWS Lambda (security groups, IP allowlisting)
3. For Supabase: ensure you're using the pooled connection string for Lambda functions
4. Check CloudWatch Logs for detailed error messages

### Missing Permissions

If deployment fails with AWS permission errors:

1. Ensure your AWS credentials have sufficient permissions to create Lambda functions, EventBridge rules, and IAM roles
2. For production, consider using a deployment role with appropriate permissions

## Future Enhancements

The Ion config includes commented examples for adding:

- API Gateway endpoints
- EventBridge Bus for event-driven architecture
- Additional Lambda functions

See the comments in `sst.config.ts` under "FUTURE API RESOURCES" for guidance.

## References

- [SST Ion Documentation](https://sst.dev/docs)
- [SST Ion Migration Guide](https://sst.dev/docs/upgrade-guide)
- [AWS Lambda Best Practices](https://docs.aws.amazon.com/lambda/latest/dg/best-practices.html)

